name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install ruff
      - run: ruff check src/ tests/

  test:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev,server]"
      - run: pytest tests/ -v --tb=short --cov=dpf --cov-report=term-missing
      - name: Verify test count
        run: |
          count=$(pytest tests/ --co -q 2>/dev/null | tail -1 | grep -oE '[0-9]+')
          echo "Found $count tests"
          if [ "$count" -lt 700 ]; then
            echo "ERROR: Expected at least 700 tests, found $count"
            exit 1
          fi

  smoke-test:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -e ".[dev,server]"
      - name: CLI smoke test (Cartesian)
        run: python -m dpf.cli.main simulate config.json --steps=10
      - name: CLI smoke test (Cylindrical)
        run: python -m dpf.cli.main simulate config_cylindrical.json --steps=10
      - name: Server smoke test
        run: |
          python -c "
          from fastapi.testclient import TestClient
          from dpf.server.app import app
          client = TestClient(app)
          r = client.get('/api/health')
          assert r.status_code == 200
          data = r.json()
          assert data['status'] == 'ok'
          assert 'backends' in data
          assert data['backends']['python'] is True
          r = client.get('/api/presets')
          assert r.status_code == 200
          assert len(r.json()) >= 3
          r = client.post('/api/simulations', json={'config': {}, 'preset': 'tutorial', 'max_steps': 3})
          assert r.status_code == 200
          print(f'Server smoke test passed: sim_id={r.json()[\"sim_id\"]}')
          "

  # Optional Athena++ tests — requires compiled C++ binaries (macOS only).
  # This job is expected to fail on GitHub-hosted runners since Athena++ is
  # not compiled in CI. It exists as a template for self-hosted runners with
  # Athena++ built.
  athena-test:
    runs-on: macos-latest
    needs: lint
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -e ".[dev,server]"
      - name: Check Athena++ availability
        run: |
          python -c "
          from dpf.athena_wrapper import is_available
          avail = is_available()
          print(f'Athena++ available: {avail}')
          if not avail:
              print('Athena++ not compiled — skipping Athena++ tests')
          "
      - name: Run Athena++ wrapper tests
        run: pytest tests/test_athena_wrapper.py tests/test_dual_engine.py -v --tb=short || true
      - name: Run Athena++ verification tests (non-slow)
        run: pytest tests/test_phase_f_verification.py -v --tb=short -m "not slow" || true
